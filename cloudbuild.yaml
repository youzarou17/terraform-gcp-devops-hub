steps:
- id: 'branch name'
  name: 'alpine'
  entrypoint: 'sh'
  args:
  - '-c'
  - 'echo ${BRANCH_NAME}'

- id: 'tf init'
  name: 'hashicorp/terraform:1.12.0'
  entrypoint: 'sh'
  args:
  - '-c'
  - |
      if [ -d "environments/${BRANCH_NAME}/" ]; then
        cd environments/${BRANCH_NAME}
        terraform init
      else
        for dir in environments/*/; do
            cd ${dir}
            terraform init || exit 1
            cd ../../
          done
      fi

- id: 'tf plan'
  name: 'hashicorp/terraform:1.12.0'
  entrypoint: 'sh'
  args:
  - '-c'
  - |
      if [ -d "environments/${BRANCH_NAME}/" ]; then
        cd environments/${BRANCH_NAME}
        terraform plan
      else
        for dir in environments/*/; do
            cd ${dir}
            terraform plan || exit 1
            cd ../../
          done
      fi
- id: 'tf apply'
  name: 'hashicorp/terraform:1.12.0'
  entrypoint: 'sh'
  args:
  - '-c'
  - |
      if [ -d "environments/${BRANCH_NAME}/" ]; then
        cd environments/${BRANCH_NAME}
        terraform apply -auto-approve
      else
      echo "branch ${BRANCH_NAME} does not exist"
options:
  logging: CLOUD_LOGGING_ONLY
